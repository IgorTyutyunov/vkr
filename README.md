# Обработка сообщения из брокера очередей RabbitMAQ

## Классы для обработки сообщений

### Класс для взаимодействия с RabbitMQ
`Igrik\Vkr\AMQP\Connector` - этот класс служит для соединения с RabbitMQ и для получения сообщений.

Также в этом классе происходит распределение сообщений по классам, которые(классы) занимаются обработкой сообщений.

### Классы для непосредственной обработки сообщений

`Igrik\Vkr\AMQP\Storage` - склад;

## Процессы для обработки сообщений

Все процессы складываются в папку `/src/amqp/processes/`.


## Автоматическое создание очередей в RabbitMQ
Для автоматического создания очередей RabbitMQ есть метод `Igrik\Vkr\AMQP\Connector::initRabbitConfig()`.

Этот метод вызывается всегда при запуске процесса для чтения сообщений из очереди.
Метод создаёт `exchange`, очереди, и связывает `exchange` и очереди. Данные для создания очередей берутся из
`Igrik\Vkr\AMQP\Connector::MAPPING_RK_CLASS`

### Создание нового обработчика сообщений и создание процесса для обработки сообщений

Для классов-обработчиков сообщений есть абстрактный класс `Igrik\Vkr\AMQP\aMessageProcessing` который
должны наследовать все классы для обработки сообщений. Соответственно в классах необходимо определить все абстрактные методы.
Также в каждом классе обязательно должны быть определены 2 константы:
1. `const QUEUE = 'product';` - название очереди, из которой будут считываться сообщения
2. `const ROUTING_KEY = 'price';` - ключ маршрутизации, который указывается отправителем при отправке сообщений

После того как класс был создан, в классе `Igrik\Vkr\AMQP\Connecto` необходимо дополнить константу-массив `MAPPING_RK_CLASS`.
Ключ записи константы - это `const ROUTING_KEY`, а значением - название класса.

#### Создание процессов обработки очередей
Все скрипты для обработки очередей лежат `/src/amqp/processes/`.
Один скрипт - это обработчик одной очереди. Если нужно создать обработчик новой очереди, то создаём скрипт с кодом

    $require_once __DIR__ . "/../../../core/init.php";
    $queue = 'storage';
    \Igrik\Vkr\AMQP\Connector::runWorkConsumer($queue);

Затем ставим системный администраторам задачу по демонизации созданного скрипта.